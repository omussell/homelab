<html><head>
	<title>omussell/github</title>

</head>

<body bgcolor="FFFFFF">

<center>
<h1>
Homelab
</h1>
</center>

<h2>
Hardware
</h2>

<pre>
<b><u>Virtualisation Host</u></b>
<b>Gigabyte Brix Pro GB-BXI7-4770R</b>
- Intel Core i7-4770R (quad core 3.2GHz)
- 16GB RAM
- 250GB mSATA SSD
- 250GB 2.5 inch SSD

<b><u>NAS</u></b>
<b>HP ProLiant G8 Microserver G1610T</b>
- Intel Celeron G1610T (dual core 2.3 GHz)
- 16GB RAM
- 2 x 250GB SSD
- 2 x 3TB HDD

<b><u>Management</u></b>
<b>Raspberry Pi 2 Model B</b>
- Quad core 1GB RAM
- 8GB MicroSD (w/ NOOBS)
</pre>

<h2>
Automating FreeBSD Jail Creation
</h2>

<pre>
Creating the template:
zfs create -o mountpoint=/usr/local/jails zroot/jails
zfs create -p zroot/jails/template

Download the base files into a new directory
mkdir ~/jails
fetch ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/10.2-RELEASE/base.txz -o ~/jails
fetch ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/10.2-RELEASE/lib32.txz -o ~/jails
fetch ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/10.2-RELEASE/ports.txz -o ~/jails

Extract the base files
tar -xf ~/jails/base.txz -C /usr/local/jails/template
tar -xf ~/jails/lib32.txz -C /usr/local/jails/template
tar -xf ~/jails/ports.txz -C /usr/local/jails/template

Copy files from host to template
cp /etc/resolv.conf /usr/local/jails/template/etc/resolv.conf
cp /etc/localtime /usr/local/jails/template/etc/localtime
mkdir -p /usr/local/template/home/username/.ssh
cp /home/username/.ssh/authorized_keys /usr/local/jails/template/home/username/.ssh

When finished, take a snapshot
zfs snapshot zroot/jails/template@1

Edit /etc/jail.conf
# Global settings applied to all jails

interface = "re0";
host.hostname = "$name";
ip4.addr = 192.168.1.$ip;
path = "/usr/local/jails/$name";

exec.start = "/bin/sh /etc/rc";
exec.stop = "/bin/sh /etc/rc.shutdown";
exec.clean;
mount.devfs;

# Jail Definitions
testjail {
	$ip = 15;
}

Run the jail
jail -c testjail

View running jails
jls

Login to the jail
jexec $jailname sh
</pre>

<h2>
New Jail Creation Script
</h2>
<pre>
#! /bin/sh
read -p "Enter jail name:" hostname
zfs clone zroot/jails/template@1 zroot/jails/$hostname
echo hostname=\"$hostname\" &gt; /usr/local/jails/$hostname/etc/rc.conf
# Disable sendmail to speed up start time
echo sendmail_submit_enable=\"NO\" &gt;&gt; /usr/local/jails/$hostname/etc/rc.conf
echo sendmail_outbound_enable=\"NO\" &gt;&gt; /usr/local/jails/$hostname/etc/rc.conf
echo sendmail_msp_queue_enable=\"NO\" &gt;&gt; /usr/local/jails/$hostname/etc/rc.conf
</pre>

<h2>
Automating Bhyve VM Creation
</h2>

<pre>
Edit /etc/sysctl.conf
net.link.tap.up_on_open=1

Edit /boot/loader.conf
vmm_load="YES"
nmdm_load="YES"
if_bridge_load="YES"
if_tap_load="YES"

Edit /etc/rc.conf
cloned_interfaces="bridge0 tap0"
ifconfig_bridge0="addm re0 addm tap0"

Create ZFS volume
zfs create -V16G -o volmode=dev zroot/testvm

Download the installation image
fetch ftp://ftp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.2/FreeBSD-10.2-RELEASE-amd64-disc1.iso 

Start the VM
sh /usr/share/examples/bhyve/vmrun.sh -c 1 -m 512M -t tap0 -d /dev/zvol/zroot/testvm -i -I FreeBSD-10.2-RELEASE-amd64-disc1.iso testvm

Install as normal, following the menu options
</pre>

<h2>
New VM Creation Script
</h2>

<pre>
#! /bin/sh
read -p "Enter hostname: " hostname
zfs create -V16G -o volmode=dev zroot/$hostname
sh /usr/share/examples/bhyve/vmrun.sh -c 1 -m 512M -t tap0 -d /dev/zvol/zroot/$hostname -i -I ~/FreeBSD-10.2-RELEASE-amd64-disc1.iso $hostname
</pre>

<h2>
Backing up VMs
</h2>

<pre>

In the FreeNAS web interface, create a new user
Account
Add User
Fill in the fields
Allow sudo
Ensure the public key is pasted into the SSH key field

Connect to the NAS over SSH
# sysctl vfs.usermount=1
# echo vfs.usermount=1 &gt;&gt; /etc/sysctl.conf
# zfs create SSD_storage/backup
# zfs allow -u user create,mount,receive SSD_storage/backup

Allow user to send snapshots
# zfs allow -u user send,snapshot zroot

Create the snapshot
$ zfs snapshot zroot/testvm@1

Send the snapshot to the NAS
$ zfs send zroot/testvm@1 | ssh user@freenas zfs recv -dvu SSD_storage/backup
</pre>

<h2>
NanoBSD
</h2>
<pre>
<a href="https://www.freebsd.org/doc/en/articles/nanobsd/index.html">NanoBSD docs</a>
<a href="https://2010.asiabsdcon.org/papers/abc2010-P4A-paper.pdf">PDF: NanoBSD, ZFS and Jails</a>
</pre>

<pre>
cd to NanoBSD build directory
cd /usr/src/tools/tools/nanobsd

Run the build script, using default values for now
sh nanobsd.sh

Wait a while for buildworld to finish

Go to output directory
cd /usr/obj/nanobsd.full

Create a new ZFS device
zfs create -V5G -o volmode=dev zroot/testnano

Copy the NanoBSD full image to the ZFS device
dd if=_.disk.full of=/dev/zvol/zroot/testnano

Run Bhyve using the ZFS device for boot
sh /usr/share/examples/bhyve/vmrun.sh -c 1 -m 512M -t tap0 -d /dev/zvol/zroot/testnano testnano

It boots! But, it can't mount root on a device... yet....
</pre>


</body>
</html>








