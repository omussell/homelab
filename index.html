<html><head>
	<title>omussell/github</title>

</head>

<body bgcolor="FFFFFF">

<center>
<h1>
Homelab</h1></center>

<h2>
Hardware</h2>

<ul style="list-style-type:none">
<li><b>Gigabyte Brix Pro GB-BXI7-4770R</b>
</li><li>- Intel Core i7-4770R (quad core 3.2Ghz)
</li><li>- 16GB RAM
</li><li>- 250GB mSATA SSD
</li><li>- 250GB 2.5 inch SSD
</li></ul>
<br>
<ul style="list-style-type:none">
<li><b>HP ProLiant G8 Microserver G1610T</b>
</li><li>- Intel Celeron G1610T (dual core, 2.3 Ghz)
</li><li>- 16GB RAM
</li><li>- 2 x 250GB SSD
</li><li>- 2 x 3TB HDD
</li></ul>
<br>

<h2>
Virtualisation Host Setup</h2>

<p>
Download FreeBSD 10.2 RELEASE amd64 uefi memstick.img from the FreeBSD website. Use the Win32DiskImager utility or dd to write the .img file to a USB stick. Once complete, boot the Brix via USB. (Hit Delete during bootup to enter BIOS and change boot options.) Follow the default install process. For disk configuration, select auto-ZFS and use striping across both disks. 
When booting from disk, it will probably fail the first time, you need to go into the BIOS and find the CSM option, then change it to enabled. When you reboot, it should boot from disk correctly.
</p>

<p>Preparing the host: Load the bhyve kernel module, then create a tap interface for the network device.</p>
<p><code># kldload vmm</code></p>
<p><code># ifconfig tap0 create</code></p>
<p><code># sysctl net.link.tap.up_on_open=1</code></p>
<p><code># ifconfig bridge0 create</code></p>
<p><code># ifconfig bridge0 addm igb0 addm tap0	### May fail, ok to continue ###</code></p>
<p><code># ifconfig bridge0 up</code></p>

<p>Creating a FreeBSD guest: Create a virtual disk for the VM, download a FreeBSD bootonly ISO, start using the vmrun.sh script</p>
<p><code># truncate -s 16G guest.img</code></p>

<p><code># fetch $path_to_FreeBSD10.2_bootonly.iso</code></p>

<p><code># sh /usr/share/examples/bhyve/vmrun.sh -c 4 -m 1024M -t tap0 -d guest.img -i -I FreeBSD10.2_bootonly.iso guestname</code></p>

<p>Reboot the VM, during reboot, press 4 to reboot to exit the loop. The guest can then be run from hard disk.</p>
<p><code># sh /usr/share/examples/bhyve/vmrun.sh -c 4 -m 1024M -t tap0 -d guest.img guestname</code></p>

<p>Using ZFS with bhyve guests: Use ZFS volumes instead of disk image files for performance benefits.</p>
<p><code># zfs create -V16G -o volmode=dev zroot/guestdisk0</code></p>
<p>When starting the VM, specify the ZFS volume as the disk drive</p>
<p><code># bhyve -A -H -P -s 0:0,hostbridge -s 1:0,lpc -s 2:0,virtio-net,tap1 -s3:0,virtio-blk,/dev/zvol/zroot/guestdisk0 -l  com1,stdio -c 4 -m 1024M guestname</code></p>


</body>
</html>
