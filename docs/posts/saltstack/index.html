<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">

        <title>Saltstack Install and Configuration</title>

        <link rel="stylesheet" href="/css/stylesheet.css">
    </head>
    <body>
        <section id="page-title">
            <h1><a href="/">Homelab</a></h1>
        </section>



<section class="blog-post">
    <h1>Saltstack Install and Configuration</h1>
    <div class="blog-post-subheader">
        January 25, 2018
    </div>
    <div class="blog-post-content">
        

<p>Install the salt package</p>

<pre><code>pkg install -y py36-salt
</code></pre>

<p>Copy the sample files to create the master and/or minion configuration files</p>

<pre><code>cp -v /usr/local/etc/salt/master{.sample,&quot;&quot;}
cp -v /usr/local/etc/salt/minion{.sample,&quot;&quot;}
</code></pre>

<p>Set the master/minion services to start on boot</p>

<pre><code>sysrc salt_master_enable=&quot;YES&quot;
sysrc salt_minion_enable=&quot;YES&quot;
</code></pre>

<p>Salt expects state files to exist in the /srv/salt or /etc/salt directories which don&rsquo;t exist by default on FreeBSD so make symlinks instead:</p>

<pre><code>ln -s /usr/local/etc/salt /etc/salt
ln -s /usr/local/etc/salt /srv/salt
</code></pre>

<p>Start the services</p>

<pre><code>service salt_master onestart
service salt_minion onestart
</code></pre>

<p>Accept minion keys sent to the master</p>

<pre><code>salt-key -A
# Press y to accept
</code></pre>

<p>Create a test state file</p>

<pre><code>vi /usr/local/etc/salt/states/examples.sls
</code></pre>

<pre><code>---

install_packages:
  pkg.installed:
    - pkgs:
      - vim-lite
</code></pre>

<p>Then apply the examples state</p>

<pre><code>salt '*' state.apply examples
</code></pre>

<h2 id="salt-formulas">Salt Formulas</h2>

<p>Install the GitFS backend, this allows you to serve files from git repos.</p>

<pre><code>pkg install -y git py36-gitpython
</code></pre>

<p>Edit the <code>/usr/local/etc/salt/master</code> configuration file:</p>

<pre><code>fileserver_backend:
  - git
  - roots
gitfs_remotes:
  - https://github.com/saltstack-formulas/lynis-formula
</code></pre>

<p>Restart the master. If master and minion are the same node, restart the minion service as well.</p>

<pre><code>service salt_master onerestart
</code></pre>

<p>The formulas can then be used in the state file</p>

<pre><code>include:
  - lynis
</code></pre>

<h2 id="salt-equivalent-to-r10k-and-using-git-as-a-pillar-source">Salt equivalent to R10K and using git as a pillar source</h2>

<p>If the git server is also a minion, you can use Reactor to signal to the master to update the fileserver on each git push:</p>

<p><code>https://docs.saltstack.com/en/latest/topics/tutorials/gitfs.html#refreshing-gitfs-upon-push</code></p>

<p>You can also use git as a pillar source (host your specific config data in version control)</p>

<p><code>https://docs.saltstack.com/en/latest/topics/tutorials/gitfs.html#using-git-as-an-external-pillar-source</code></p>

<h2 id="installing-raet">Installing RAET</h2>

<p>RAET support isn&rsquo;t enabled in the default package. If you install py27-salt and run <code>pkg info py27-salt</code> you can see in the options <code>RAET: off</code>. In order to use RAET, you need to build the py27-salt port.</p>

<p>Compile the port</p>

<pre><code>pkg remove -y py27-salt
portsnap fetch extract
cd /usr/ports/sysutil/py-salt
make config
# Press space to select RAET
make install
</code></pre>

<p>Edit <code>/srv/salt/master</code> and <code>/srv/salt/minion</code> and add</p>

<pre><code>transport: raet
</code></pre>

<p>Then restart the services</p>

<pre><code>service salt_master restart
service salt_minion restart
</code></pre>

<p>You will need to accept keys again</p>

<pre><code>salt-key 
salt-key -A
</code></pre>

<h2 id="salt-equivalent-of-hiera-eyaml">Salt equivalent of hiera-eyaml</h2>

<p>Salt.runners.nacl</p>

<p>Similar to hiera-eyaml, it is used for encrypting data stored in pillar:</p>

<p><code>https://docs.saltstack.com/en/latest/ref/runners/all/salt.runners.nacl.html</code></p>

    </div>
</section>

    </body>
</html>