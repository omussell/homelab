<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">

        <title>Postgresql 10.1 with replication and WAL archiving</title>

        <link rel="stylesheet" href="/css/stylesheet.css">
    </head>
    <body>
        <section id="page-title">
            <h1><a href="/">Homelab</a></h1>
        </section>



<section class="blog-post">
    <h1>Postgresql 10.1 with replication and WAL archiving</h1>
    <div class="blog-post-subheader">
        January 25, 2018
    </div>
    <div class="blog-post-content">
        

<h2 id="postgresql-10-1-install">Postgresql 10.1 install</h2>

<pre><code>pkg install -y postgresql10-server postgresql10-client
sysrc postgresql_enable=YES
service postgresql initdb
service postgresql start
</code></pre>

<h2 id="postgresql-10-1-scram-authentication">Postgresql 10.1 SCRAM Authentication</h2>

<pre><code>su - postgres
psql
set password_encryption = 'scram-sha-256';
create role app_db with password 'foo';
select substring(rolpassword, 1, 14) from pg_authid where rolname = 'app_db';
</code></pre>

<h2 id="postgresql-10-1-using-repmgr-for-database-replication-wal-g-for-wal-archiving-and-minio-for-s3-compatible-storage">Postgresql 10.1 using repmgr for database replication, WAL-G for WAL archiving, and minio for S3 compatible storage</h2>

<p>For this, I created two bhyve VMs to host postgresql and a jail on the host for minio</p>

<p>Make sure postgresql is running</p>

<p>Carry out the following steps on both primary and replicas</p>

<p>The current packaged version of repmgr is 3.3.1 which isn&rsquo;t the latest. The latest is 4.0.1, so we need to compile it ourself, and put files into the correct locations</p>

<pre><code>fetch https://repmgr.org/download/repmgr-4.0.1.tar.gz
tar -zvxf repmgr-4.0.1.tar.gz
./configure
pkg install -y gmake
gmake
</code></pre>

<p>Copy the repmgr files to their correct locations</p>

<pre><code>cp -v repmgr /var/db/postgres
cp -v repmgr--4.0.sql /usr/local/share/postgresql/extension/
cp -v repmgr.control /usr/local/share/postgresql/extension
</code></pre>

<p>vim /var/db/postgrs/data10/postgresql.conf</p>

<p>Add lines:</p>

<pre><code>include_dir = 'postgresql.conf.d'
listen_addresses = '\*'
</code></pre>

<p>vim /var/db/postgres/data10/postgresql.conf.d/postgresql.replication.conf</p>

<p>Add lines:</p>

<pre><code>max_wal_senders = 10
wal_level = 'replica'
wal_keep_segments = 5000
hot_standby = on
archive_mode = on
archive_command = 'wal-g stuff here'
</code></pre>

<p>vim /var/db/postgres/data10/pg_hba.conf</p>

<p>Add lines:
Please note, for testing purposes, these rules are wide open and allow everything. Dont do this in production, use a specific role with a password and restrict to a specific address</p>

<pre><code>local	all		all			trust
host	all		all	0.0.0.0/0	trust
host	replication	all	0.0.0.0/0	trust
</code></pre>

<p>vim /usr/local/etc/repmgr.conf</p>

<p>Add lines:</p>

<pre><code>node_id=1 # arbitrary number, each node needs to be unique
node_name=postgres-db1 # this nodes hostname
conninfo='host=192.168.1.10 user=repmgr dbname=repmgr' # the host value should be a hostname if DNS is working
</code></pre>

<p>On the primary</p>

<pre><code>su - postgres
createuser -s repmgr
createdb repmgr -O repmgr

repmgr -f /usr/local/etc/repmgr.conf primary register
repmgr -f /usr/local/etc/repmgr.conf cluster show
</code></pre>

<p>On a standby</p>

<pre><code>su - postgres
psql 'host=node1 user=repmgr dbname=repmgr'
</code></pre>

<p>To clone the primary, the data directory on the standby node must exist but be empty</p>

<pre><code>rm -rf /var/db/postgres/data10/
mkdir -p /var/db/postgres/data10
chown postgres:postgres /var/db/postgres/data10
</code></pre>

<p>Dry run first to check for problems</p>

<p><code>repmgr -h node1 -U repmgr -d repmgr -f /usr/local/etc/repmgr.conf standby clone --dry-run</code></p>

<p>If its ok, run it</p>

<p><code>repmgr -h node1 -U repmgr -d repmgr -f /usr/local/etc/repmgr.conf standby clone</code></p>

<p>On the primary</p>

<pre><code>su - postgres
psql -d repmgr
select * from pg_stat_replication;
</code></pre>

<p>On the standby</p>

<pre><code>repmgr -f /usr/local/etc/repmgr.conf standby register
repmgr -f /usr/local/etc/repmgr.conf cluster show
</code></pre>

<p>Install minio</p>

<pre><code>pkg install -y minio
sysrc minio_enable=YES
sysrc minio_disks=/home/user/test
mkdir -p /home/user/test
chown minio:minio /home/user/test
service minio start
# The access keys are in /usr/local/etc/minio/config.json
# You can change them in this file and restart the service to take effect
</code></pre>

<p>On the primary
WAL-G</p>

<pre><code>pkg install -y go
mkdir -p /root/go
setenv GOPATH /root/go
cd go
go get github.com/wal-g/wal-g
cd src/github.com/wal-g/wal-g
make all
make install
cp /root/go/bin/wal-g /usr/local/bin
</code></pre>

<p>WAL-G requires certain environment variables to be set. This can be done using envdir, part of the daemontools package</p>

<p>pkg install -y daemontools</p>

<p>Setup is now complete.</p>

<p>For operations, a base backup needs to be taken on a regular basis probably via a cron job, running the following command as postgres user</p>

<p><code>wal-g backup-push /var/db/postgres/data10</code></p>

<p>Then the archive_command in the postgresql.replication.conf should be set to the wal-push command</p>

<p><code>wal-g wal-push /var/db/postgres/data10</code></p>

<p>To restore, backup-fetch and wal-fetch can be used to pull the latest base backup and the necessary wal logs to recover to the latest transaction</p>

    </div>
</section>

    </body>
</html>