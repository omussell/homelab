<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">

        <title>NSD and Unbound Configuration</title>

        <link rel="stylesheet" href="/css/stylesheet.css">
    </head>
    <body>
        <section id="page-title">
            <h1><a href="/">Homelab</a></h1>
        </section>



<section class="blog-post">
    <h1>NSD and Unbound Configuration</h1>
    <div class="blog-post-subheader">
        January 25, 2018
    </div>
    <div class="blog-post-content">
        

<p>Set up the unbound/nsd-control</p>

<pre><code>local-unbound-setup
nsd-control-setup
</code></pre>

<p>Enable NSD and Unbound to start in <code>/etc/rc.conf</code></p>

<pre><code>sysrc nsd_enable=&quot;YES&quot;
sysrc local_unbound_enable=&quot;YES&quot;
</code></pre>

<p>Set a different listening port for NSD in <code>/usr/local/etc/nsd.conf</code></p>

<pre><code>server:
  port: 5353
</code></pre>

<p>Create an inital zone file <code>/usr/local/etc/nsd/home.lan.zone</code></p>

<pre><code>$ORIGIN home.lan. ;
$TTL 86400 ;

@ IN SOA ns1.home.lan. admin.home.lan. (
        2017080619 ;
        28800 ;
        7200 ;
        864000 ;
        86400 ;
        )

        NS ns1.home.lan.

ns1 IN A 192.168.1.15
jail IN A 192.168.1.15
</code></pre>

<p>Create the reverse lookup zone file <code>/usr/local/etc/nsd/home.lan.reverse</code></p>

<pre><code>$ORIGIN home.lan.
$TTL 86400

0.1.168.192.in-addr.arpa. IN SOA ns1.home.lan. admin.home.lan. (
        2017080619
        28800
        7200
        864000
        86400
        )

        NS ns1.home.lan.

15.1.168.192.in-addr.arpa. IN PTR jail
15.1.168.192.in-addr.arpa. IN PTR ns1
</code></pre>

<h2 id="opendnssec">OpenDNSSEC</h2>

<p>Install the required packages</p>

<pre><code>pkg install -y opendnssec softhsm
</code></pre>

<p>Set the softhsm database location in <code>/usr/local/etc/softhsm.conf</code></p>

<pre><code>0:/var/lib/softhsm/slot0.db
</code></pre>

<p>Initialise the token database:</p>

<pre><code>softhsm --init-token --slot 0 --label &quot;OpenDNSSEC&quot;
Enter the PIN for the SO and then the USER.
</code></pre>

<p>Make sure opendnssec has permission to access the token database</p>

<pre><code>chown opendnssec /var/lib/softhsm/slot0.db
chgrp opendnssec /var/lib/softhsm/slot0.db
</code></pre>

<p>Set some options for OpenDNSSEC in <code>/usr/local/etc/opendnssec/conf.xml</code></p>

<pre><code>&lt;Repository name=&quot;SoftHSM&quot;&gt;
        &lt;Module&gt;/usr/local/lib/softhsm/libsofthsm.so&lt;/Module&gt;
        &lt;TokenLabel&gt;OpenDNSSEC&lt;/TokenLabel&gt;
        &lt;PIN&gt;1234&lt;/PIN&gt;
        &lt;SkipPublicKey/&gt;
&lt;/Repository&gt;
</code></pre>

<p>Edit <code>/usr/local/etc/opendnssec/kasp.xml</code>. Change unixtime to datecounter in the Serial parameter. This allows us to use YYYYMMDDXX format for the SOA SERIAL values.</p>

<pre><code>&lt;Zone&gt;
        &lt;PropagationDelay&gt;PT300S&lt;/PropagationDelay&gt;
        &lt;SOA&gt;
                &lt;TTL&gt;PT300S&lt;/TTL&gt;
                &lt;Minimum&gt;PT300S&lt;/Minimum&gt;
                &lt;Serial&gt;datecounter&lt;/Serial&gt;
        &lt;/SOA&gt;
&lt;/Zone&gt;
</code></pre>

    </div>
</section>

    </body>
</html>