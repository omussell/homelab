<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">

        <title>Bhyve VM Creation</title>

        <link rel="stylesheet" href="/homelab/css/stylesheet.css">
    </head>
    <body>
        <section id="page-title">
            <h1><a href="/">Homelab</a></h1>
        </section>



<section class="blog-post">
    <h1>Bhyve VM Creation</h1>
    <div class="blog-post-subheader">
        January 25, 2018
    </div>
    <div class="blog-post-content">
        

<h2 id="bhyve-initial-setup">Bhyve Initial Setup</h2>

<p>Enable the tap interface in <code>/etc/sysctl.conf</code> and load it on the currently running system</p>

<pre><code>net.link.tap.up_on_open=1
sysctl -f /etc/sysctl.conf
</code></pre>

<p>Enable bhyve, serial console and bridge/tap interface kernel modules in <code>/boot/loader.conf</code>. Reboot to apply changes or use kldload.</p>

<pre><code>vmm_load=&quot;YES&quot;
nmdm_load=&quot;YES&quot;
if_bridge_load=&quot;YES&quot;
if_tap_load=&quot;YES&quot;
</code></pre>

<p>Set up the network interfaces in <code>/etc/rc.conf</code></p>

<pre><code>cloned_interfaces=&quot;bridge0 tap0&quot;
ifconfig_bridge0=&quot;addm re0 addm tap0&quot;
</code></pre>

<p>Create a ZFS volume</p>

<pre><code>zfs create -V16G -o volmode=dev zroot/testvm
</code></pre>

<p>Download the installation image</p>

<pre><code>fetch ftp://ftp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/11.1/FreeBSD-11.1-RELEASE-amd64-disc1.iso 
</code></pre>

<p>Start the VM</p>

<pre><code>sh /usr/share/examples/bhyve/vmrun.sh -c 1 -m 512M -t tap0 -d /dev/zvol/zroot/testvm -i -I FreeBSD-11.1-RELEASE-amd64-disc1.iso testvm
</code></pre>

<p>Install as normal, following the menu options</p>

<h2 id="new-vm-creation-script">New VM Creation Script</h2>

<pre><code>#! /bin/sh
read -p &quot;Enter hostname: &quot; hostname
zfs create -V16G -o volmode=dev zroot/$hostname
sh /usr/share/examples/bhyve/vmrun.sh -c 1 -m 512M -t tap0 -d /dev/zvol/zroot/$hostname -i -I ~/FreeBSD-11.1-RELEASE-amd64-disc1.iso $hostname
</code></pre>

<h2 id="creating-a-linux-guest">Creating a Linux guest</h2>

<p>Create a file for the hard disk</p>

<pre><code>truncate -s 16G linux.img
</code></pre>

<p>Create the file to map the virtual devices for kernel load</p>

<pre><code>~/device.map

(hd0) /root/linux.img
(cd0) /root/linux.iso
</code></pre>

<p>Load the kernel</p>

<pre><code>grub-bhyve -m ~/device.map -r cd0 -M 1024M linuxguest
</code></pre>

<p>Grub should start, choose install as normal</p>

<p>Start the VM</p>

<pre><code>bhyve -A -H -P -s 0:0,hostbridge -s 1:0,lpc -s 2:0,virtio-net,tap0 -s 3:0,virtio-blk,/root/linux.img -l com1,/dev/nmdm0A -c 1 -m 512M linuxguest
</code></pre>

<p>Access through the serial console</p>

<pre><code>cu -l /dev/nmdm0B
</code></pre>

<h2 id="pfsense-in-a-vm">pfSense in a VM</h2>

<p>Download the pfSense disk image from the website using fetch</p>

<pre><code>fetch https://frafiles.pfsense.org/mirror/downloads/pfSense-CE-2.3.1-RELEASE-2g-amd64-nanobsd.img.gz -o ~/pfSense.img.gz
</code></pre>

<p>Create the storage</p>

<pre><code>zfs create -V2G -o volmode=dev zroot/pfsense
</code></pre>

<p>Unzip the file, and redirect output to the storage via dd</p>

<pre><code>gzip -dc pfSense.img.gz | dd of=/dev/zvol/zroot/pfsense obs=64k
</code></pre>

<p>Load the kernel and start the boot process</p>

<pre><code>bhyveload -c /dev/nmdm0A -d /dev/zvol/zroot/pfsense -m 256MB pfsense
</code></pre>

<p>Start the VM</p>

<pre><code>/usr/sbin/bhyve -c 1 -m 256 -A -H -P -s 0:0,hostbridge -s 1:0,virtio-net,tap0 -s 3:0,ahci-hd,/dev/zvol/zroot/pfsense -s 4:1,lpc -l com1,/dev/nmdm0A pfsense
</code></pre>

<p>Connect to the VM via the serial connection with nmdm</p>

<pre><code>cu -l /dev/nmdm0B
</code></pre>

<p>Perform initial configuration through the shell to assign the network interfaces</p>

<p>Once done, use the IP address to access through the web console</p>

<p>When finished, you can shutdown/reboot</p>

<p>To de-allocate the resources, you need to destroy the VM</p>

<pre><code>bhyvectl --destroy --vm=pfsense
</code></pre>

<h2 id="multiple-vms-using-bhyve">Multiple VMs using bhyve</h2>

<p>To allow networking on multiple vms, there should be a tap assigned to each vm, connected to the same bridge.</p>

<pre><code>cloned_interfaces=&quot;bridge0 tap0 tap1 tap2&quot;
ifconfig_bridge0=&quot;addm re0 addm tap0 addm tap1 addm tap2&quot;
</code></pre>

<p>Then when you provision vms, assign one of the tap interfaces to them.</p>

    </div>
</section>

    </body>
</html>